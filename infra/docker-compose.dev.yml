services:
  db_auth:
    image: postgres:16
    container_name: auth_db_dev
    restart: unless-stopped
    env_file:
      - ./secrets/db_auth.env
    volumes:
      - auth_pgdata_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20
    ports:
      - "5436:5432"

  auth_service:
    build:
      context: ..
      dockerfile: services/auth_service/Dockerfile
    container_name: auth_service_dev
    depends_on:
      db_auth:
        condition: service_healthy
    env_file:
      - ./secrets/auth_service.env
    volumes:
      - ../services/auth_service/app:/app/app
      - ../services/auth_service/migrations:/app/migrations
      - ../services/auth_service/alembic.ini:/app/alembic.ini
      - ../shared:/app/shared
    ports:
      - "8001:8001"
      - "5678:5678"
    command: >
      sh -c "alembic upgrade head || true;
             uvicorn app.app:create_app --factory --host 0.0.0.0 --port 8001 --reload --reload-exclude 'migrations/*'"
    restart: unless-stopped

  db_courses:
    image: postgres:16
    container_name: courses_db_dev
    env_file:
      - ./secrets/db_courses.env
    volumes:
      - courses_pgdata_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20

  courses_service:
    build:
      context: ..
      dockerfile: services/courses_service/Dockerfile
    container_name: courses_service_dev
    depends_on:
      db_courses:
        condition: service_healthy
      auth_service:
        condition: service_started
    env_file:
      - ./secrets/courses_service.env
    volumes:
      - ../services/courses_service/app:/app/app
      - ../services/courses_service/migrations:/app/migrations
      - ../services/courses_service/alembic.ini:/app/alembic.ini
      - ../shared:/app/shared
    ports:
      - "8002:8002"
    command: >
      sh -c "alembic upgrade head || true;
             uvicorn app.app:create_app --factory --host 0.0.0.0 --port 8002 --reload"

  db_progress:
    image: postgres:16
    container_name: progress_db_dev
    env_file:
      - ./secrets/db_progress.env
    volumes:
      - progress_pgdata_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20

  progress_service:
    build:
      context: ..
      dockerfile: services/progress_service/Dockerfile
    container_name: progress_service_dev
    depends_on:
      db_progress:
        condition: service_healthy
    env_file:
      - ./secrets/progress_service.env
    volumes:
      - ../services/progress_service/app:/app/app
      - ../services/progress_service/migrations:/app/migrations
      - ../services/progress_service/alembic.ini:/app/alembic.ini
      - ../shared:/app/shared
    ports:
      - "8003:8003"
    command: >
      sh -c "alembic upgrade head || true;
             uvicorn app.app:create_app --factory --host 0.0.0.0 --port 8003 --reload"

volumes:
  auth_pgdata_dev:
  courses_pgdata_dev:
  progress_pgdata_dev:
